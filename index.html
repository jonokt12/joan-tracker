<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Time Tracker</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 30px;
      text-align: center;
    }

    h2 {
      color: #34495e;
      margin-top: 40px;
      margin-bottom: 20px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }

    form {
      display: grid;
      gap: 20px;
      margin-bottom: 40px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }

    input[type="date"],
    input[type="number"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    input[type="number"] {
      max-width: 200px;
    }

    button {
      background: #3498db;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #2980b9;
    }

    .message {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 40px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .chart-container {
      margin-top: 30px;
      position: relative;
      height: 400px;
    }

    .database-controls {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 30px;
      display: flex;
      gap: 30px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .db-selector, .db-creator {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .db-selector label {
      margin-bottom: 0;
    }

    #dbSelect {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      min-width: 200px;
    }

    #newDbName {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      min-width: 200px;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    #createDbBtn {
      background: #27ae60;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }

    #createDbBtn:hover {
      background: #229954;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      input[type="number"] {
        max-width: 100%;
      }

      .chart-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Study Time Tracker</h1>

    <div class="database-controls">
      <div class="db-selector">
        <label for="dbSelect">Database:</label>
        <select id="dbSelect">
          {{DATABASE_OPTIONS}}
        </select>
        <button id="deleteDbBtn" class="btn-danger">Delete</button>
      </div>
      <div class="db-creator">
        <input type="text" id="newDbName" placeholder="New database name">
        <button id="createDbBtn">Create New</button>
      </div>
    </div>

    <div id="message" class="message"></div>

    <form id="studyForm">
      <div class="form-group">
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required value="{{TODAY_DATE}}">
      </div>

      <div class="form-group">
        <label for="textbook">Textbook Reading (minutes):</label>
        <input type="number" id="textbook" name="textbook" min="0" max="1440" value="0">
      </div>

      <div class="form-group">
        <label for="podcast">Podcast Listening (minutes):</label>
        <input type="number" id="podcast" name="podcast" min="0" max="1440" value="0">
      </div>

      <div class="form-group">
        <label for="notes">Note Writing (minutes):</label>
        <input type="number" id="notes" name="notes" min="0" max="1440" value="0">
      </div>

      <div class="form-group">
        <label for="flashcards">Flashcard Questions (minutes):</label>
        <input type="number" id="flashcards" name="flashcards" min="0" max="1440" value="0">
      </div>

      <div class="form-group">
        <label for="practice">Practice Questions (minutes):</label>
        <input type="number" id="practice" name="practice" min="0" max="1440" value="0">
      </div>
      
      <div class="form-group">
        <label for="inperson">In-person teaching (minutes):</label>
        <input type="number" id="inperson" name="inperson" min="0" max="1440" value="0">
      </div>      

      <div class="form-group">
        <label for="lecture">Recorded lecture (minutes):</label>
        <input type="number" id="lecture" name="lecture" min="0" max="1440" value="0">
      </div>     

      <button type="submit">Submit Study Time</button>
    </form>

    <h2>Running Totals</h2>
    <table>
      <thead>
        <tr>
          <th>Category</th>
          <th>Total Minutes</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Textbook Reading</td>
          <td>{{TOTAL_TEXTBOOK}}</td>
          <td>{{PERCENT_TEXTBOOK}}%</td>
        </tr>
        <tr>
          <td>Podcast Listening</td>
          <td>{{TOTAL_PODCAST}}</td>
          <td>{{PERCENT_PODCAST}}%</td>
        </tr>
        <tr>
          <td>Note Writing</td>
          <td>{{TOTAL_NOTES}}</td>
          <td>{{PERCENT_NOTES}}%</td>
        </tr>
        <tr>
          <td>Flashcard Questions</td>
          <td>{{TOTAL_FLASHCARDS}}</td>
          <td>{{PERCENT_FLASHCARDS}}%</td>
        </tr>
        <tr>
          <td>Practice Questions</td>
          <td>{{TOTAL_PRACTICE}}</td>
          <td>{{PERCENT_PRACTICE}}%</td>
        </tr>
        <tr>
          <td>In-person teaching</td>
          <td>{{TOTAL_INPERSON}}</td>
          <td>{{PERCENT_INPERSON}}%</td>
        </tr>
        <tr>
          <td>Recorded lecture watching</td>
          <td>{{TOTAL_LECTURE}}</td>
          <td>{{PERCENT_LECTURE}}%</td>
        </tr>                
        <tr style="font-weight: bold; background: #f8f9fa;">
          <td>Total</td>
          <td>{{GRAND_TOTAL}}</td>
          <td>100%</td>
        </tr>
      </tbody>
    </table>

    <h2>Daily Study Time</h2>
    <div class="chart-container">
      <canvas id="dailyChart"></canvas>
    </div>

    <h2>Running Totals Over Time</h2>
    <div class="chart-container">
      <canvas id="runningTotalChart"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // Database selection
    document.getElementById('dbSelect').addEventListener('change', async (e) => {
      try {
        const response = await fetch('/api/switch-db', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ database: e.target.value })
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert('Error switching database');
        }
      } catch (error) {
        alert('Error switching database: ' + error.message);
      }
    });

    // Create new database
    document.getElementById('createDbBtn').addEventListener('click', async () => {
      const dbName = document.getElementById('newDbName').value.trim();
      if (!dbName) {
        alert('Please enter a database name');
        return;
      }

      try {
        const response = await fetch('/api/create-db', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: dbName })
        });

        const result = await response.json();

        if (response.ok) {
          window.location.reload();
        } else {
          alert(result.error || 'Error creating database');
        }
      } catch (error) {
        alert('Error creating database: ' + error.message);
      }
    });

    // Delete database
    document.getElementById('deleteDbBtn').addEventListener('click', async () => {
      const dbSelect = document.getElementById('dbSelect');
      const dbName = dbSelect.value;

      if (dbSelect.options.length <= 1) {
        alert('Cannot delete the last database');
        return;
      }

      if (!confirm(`Are you sure you want to delete "${dbName.replace('.json', '')}"? This cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch('/api/delete-db', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ database: dbName })
        });

        const result = await response.json();

        if (response.ok) {
          window.location.reload();
        } else {
          alert(result.error || 'Error deleting database');
        }
      } catch (error) {
        alert('Error deleting database: ' + error.message);
      }
    });

    // Form submission
    document.getElementById('studyForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        date: document.getElementById('date').value,
        textbook: parseInt(document.getElementById('textbook').value) || 0,
        podcast: parseInt(document.getElementById('podcast').value) || 0,
        notes: parseInt(document.getElementById('notes').value) || 0,
        flashcards: parseInt(document.getElementById('flashcards').value) || 0,
        practice: parseInt(document.getElementById('practice').value) || 0,
        inperson: parseInt(document.getElementById('inperson').value) || 0,
        lecture: parseInt(document.getElementById('lecture').value) || 0
      };

      try {
        const response = await fetch('/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        const messageDiv = document.getElementById('message');
        if (response.ok) {
          messageDiv.textContent = result.message;
          messageDiv.className = 'message success';
          messageDiv.style.display = 'block';

          // Reload page after short delay to show updated stats
          setTimeout(() => window.location.reload(), 1000);
        } else {
          messageDiv.textContent = result.error || 'Error submitting data';
          messageDiv.className = 'message error';
          messageDiv.style.display = 'block';
        }
      } catch (error) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = 'Error submitting data: ' + error.message;
        messageDiv.className = 'message error';
        messageDiv.style.display = 'block';
      }
    });

    // Load daily totals chart
    async function loadDailyChart() {
      try {
        const response = await fetch('/api/data');
        const data = await response.json();

        if (data.entries.length === 0) {
          return;
        }

        // Aggregate entries by date (sum all entries for the same date)
        const dailyTotals = {};
        data.entries.forEach(entry => {
          if (!dailyTotals[entry.date]) {
            dailyTotals[entry.date] = {
              textbook: 0,
              podcast: 0,
              notes: 0,
              flashcards: 0,
              practice: 0,
              inperson: 0,
              lecture: 0
            };
          }
          dailyTotals[entry.date].textbook += entry.textbook || 0;
          dailyTotals[entry.date].podcast += entry.podcast || 0;
          dailyTotals[entry.date].notes += entry.notes || 0;
          dailyTotals[entry.date].flashcards += entry.flashcards || 0;
          dailyTotals[entry.date].practice += entry.practice || 0;
          dailyTotals[entry.date].inperson += entry.inperson || 0;
          dailyTotals[entry.date].lecture += entry.lecture || 0;
        });

        // Sort dates
        const dates = Object.keys(dailyTotals).sort((a, b) => new Date(a) - new Date(b));

        // Create data arrays for each category
        const textbookData = dates.map(date => dailyTotals[date].textbook);
        const podcastData = dates.map(date => dailyTotals[date].podcast);
        const notesData = dates.map(date => dailyTotals[date].notes);
        const flashcardsData = dates.map(date => dailyTotals[date].flashcards);
        const practiceData = dates.map(date => dailyTotals[date].practice);
        const inpersonData = dates.map(date => dailyTotals[date].inperson);
        const lectureData = dates.map(date => dailyTotals[date].lecture);
        const totalData = dates.map(date =>
          dailyTotals[date].textbook + dailyTotals[date].podcast +
          dailyTotals[date].notes + dailyTotals[date].flashcards +
          dailyTotals[date].inperson + dailyTotals[date].lecture +
          dailyTotals[date].practice
        );

        const ctx = document.getElementById('dailyChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'Total',
                data: totalData,
                borderColor: '#2c3e50',
                backgroundColor: 'rgba(44, 62, 80, 0.1)',
                borderWidth: 3,
                tension: 0.1
              },
              {
                label: 'Textbook',
                data: textbookData,
                borderColor: '#3498db',
                borderWidth: 2,
                tension: 0.1
              },
              {
                label: 'Podcast',
                data: podcastData,
                borderColor: '#e74c3c',
                borderWidth: 2,
                tension: 0.1
              },
              {
                label: 'Notes',
                data: notesData,
                borderColor: '#2ecc71',
                borderWidth: 2,
                tension: 0.1
              },
              {
                label: 'Flashcards',
                data: flashcardsData,
                borderColor: '#f39c12',
                borderWidth: 2,
                tension: 0.1
              },
              {
                label: 'Practice',
                data: practiceData,
                borderColor: '#9b59b6',
                borderWidth: 2,
                tension: 0.1
              }
              {
                label: 'In-person',
                data: inpersonData,
                borderColor: '#9b59b6',
                borderWidth: 2,
                tension: 0.1
              }
              {
                label: 'Lecture',
                data: lectureData,
                borderColor: '#9b59b6',
                borderWidth: 2,
                tension: 0.1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              },
              title: {
                display: true,
                text: 'Daily Study Time by Category'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Minutes'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Date'
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading daily chart:', error);
      }
    }

    // Load running totals chart
    async function loadRunningTotalChart() {
      try {
        const response = await fetch('/api/data');
        const data = await response.json();

        if (data.entries.length === 0) {
          return;
        }

        // Aggregate entries by date (sum all entries for the same date)
        const dailyTotals = {};
        data.entries.forEach(entry => {
          if (!dailyTotals[entry.date]) {
            dailyTotals[entry.date] = {
              textbook: 0,
              podcast: 0,
              notes: 0,
              flashcards: 0,
              practice: 0,
              inperson: 0,
              lecture: 0
            };
          }
          dailyTotals[entry.date].textbook += entry.textbook || 0;
          dailyTotals[entry.date].podcast += entry.podcast || 0;
          dailyTotals[entry.date].notes += entry.notes || 0;
          dailyTotals[entry.date].flashcards += entry.flashcards || 0;
          dailyTotals[entry.date].practice += entry.practice || 0;
          dailyTotals[entry.date].inperson += entry.inperson || 0;
          dailyTotals[entry.date].lecture += entry.lecture || 0;
        });

        // Sort dates
        const dates = Object.keys(dailyTotals).sort((a, b) => new Date(a) - new Date(b));

        // Calculate running totals (cumulative sum by day)
        let runningTotals = {
          textbook: [],
          podcast: [],
          notes: [],
          flashcards: [],
          practice: [],
          inperson: [],
          lecture: [],
          total: []
        };

        let cumulativeTextbook = 0;
        let cumulativePodcast = 0;
        let cumulativeNotes = 0;
        let cumulativeFlashcards = 0;
        let cumulativePractice = 0;
        let cumulativeInperson = 0;
        let cumulativeLecture = 0;

        dates.forEach((date) => {
          const dayData = dailyTotals[date];

          cumulativeTextbook += dayData.textbook;
          cumulativePodcast += dayData.podcast;
          cumulativeNotes += dayData.notes;
          cumulativeFlashcards += dayData.flashcards;
          cumulativePractice += dayData.practice;
          cumulativeInperson += dayData.inperson;
          cumulativeLecture += dayData.lecture;

          runningTotals.textbook.push(cumulativeTextbook);
          runningTotals.podcast.push(cumulativePodcast);
          runningTotals.notes.push(cumulativeNotes);
          runningTotals.flashcards.push(cumulativeFlashcards);
          runningTotals.practice.push(cumulativePractice);
          runningTotals.inperson.push(cumulativeInperson);
          runningTotals.lecture.push(cumulativeLecture);
          runningTotals.total.push(
            cumulativeTextbook + cumulativePodcast + cumulativeNotes +
            cumulativeFlashcards + cumulativePractice + cumulativeInperson + cumulativeLecture
          );
        });

        const ctx = document.getElementById('runningTotalChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'Total',
                data: runningTotals.total,
                borderColor: '#2c3e50',
                backgroundColor: 'rgba(44, 62, 80, 0.1)',
                borderWidth: 3,
                tension: 0.1
              },
              {
                label: 'Textbook',
                data: runningTotals.textbook,
                borderColor: '#3498db',
                borderWidth: 2,
                tension: 0.1
              },
              {
                label: 'Podcast',
                data: runningTotals.podcast,
                borderColor: '#e74c3c',
                borderWidth: 2,
                tension: 0.1
              },
              {
                label: 'Notes',
                data: runningTotals.notes,
                borderColor: '#2ecc71',
                borderWidth: 2,
                tension: 0.1
              },
              {
                label: 'Flashcards',
                data: runningTotals.flashcards,
                borderColor: '#f39c12',
                borderWidth: 2,
                tension: 0.1
              },
              {
                label: 'Practice',
                data: runningTotals.practice,
                borderColor: '#9b59b6',
                borderWidth: 2,
                tension: 0.1
              }
              {
                label: 'In-person',
                data: runningTotals.inperson,
                borderColor: '#9b59b6',
                borderWidth: 2,
                tension: 0.1
              }
              {
                label: 'Lectures',
                data: runningTotals.lecture,
                borderColor: '#9b59b6',
                borderWidth: 2,
                tension: 0.1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              },
              title: {
                display: true,
                text: 'Cumulative Study Time by Category'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Total Minutes'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Date'
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading running total chart:', error);
      }
    }

    loadDailyChart();
    loadRunningTotalChart();
  </script>
</body>
</html>
